---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.path = "man/figures/README-",
  out.width = "60%"
)
```

# clinpubr: Clinical Publication with R

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/clinpubr)](https://CRAN.R-project.org/package=clinpubr)
[![Codecov test coverage](https://codecov.io/gh/yotasama/clinpubr/graph/badge.svg)](https://app.codecov.io/gh/yotasama/clinpubr)
[![R-CMD-check](https://github.com/yotasama/clinpubr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/yotasama/clinpubr/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

## Overview
`clinpubr` is an R package designed to streamline the workflow from clinical data processing to publication-ready outputs. It provides tools for clinical data cleaning, significant result screening, and generating tables/figures suitable for medical journals.

## Key Features
- **Clinical Data Cleaning**: Functions to handle missing values, standardize units, convert dates, and clean numerical/categorical variables.  
- **Significant Result Screening**: Tools for interaction analysis, model comparison, and regression result with common variable transformations to identify key findings.  
- **Publication-Ready Outputs**: Generate baseline characteristic tables, forest plots, RCS curves, and other visualizations formatted for medical publications.  

## Installation

You can install the development version of clinpubr from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("yotasama/clinpubr")
```

## Basic Usage
### Cleaning Tools
#### Example 1.1: Standardize Values in Medical Records
```{r example_1.1}
library(clinpubr)

# Sample messy data
messy_data <- data.frame(values = c("１２．３", "0..45", "  67 ", "", "ａｂａｎｄｏｎ"))
clean_data <- value_initial_cleaning(messy_data$values)
print(clean_data)
```

#### Example 1.2: Check Non-numerical Values
```{r example_1.2}
# Sample messy data
x <- c("1.2(XXX)", "1.5", "0.82", "5-8POS", "NS", "FULL")
print(check_nonnum(x))
```
This function filters out non-numerical values, which helps you choose the
appropriate method to handle them. 

#### Example 1.3: Extracting Numerical Values from Text
```{r example_1.3}
# Sample messy data
x <- c("1.2(XXX)", "1.5", "0.82", "5-8POS", "NS", "FULL")
print(extract_num(x))

print(extract_num(x,
  res_type = "first", # Extract the first number
  multimatch2na = TRUE, # Convert illegal multiple matches to NA
  zero_regexp = "NEG|NS", # Convert "NEG" and "NS" (matched using regex) to 0
  max_regexp = "FULL", # Convert "FULL" (matched using regex) to some specified quantile
  max_quantile = 0.95
))
```

#### Other Cleaning Functions
- *`to_date()`*: Convert text to date, can handle mixed format. 
- *`unit_view()`* and *`unit_standardize()`*: Provide a pipeline to standardize conflicting units.  
- *`cut_by()`*: Split numerics into factors, offers a variety of splitting options and auto labeling.  
- And more...  

### Generating Publication-Ready Tables and Figures
#### Example 3.1: Automatic Type Infer and Baseline Table Generation
```{r example_3.1}
var_types <- get_var_types(mtcars, strata = "vs") # Automatically infer variable types
print(var_types)

tables <- baseline_table(mtcars,
  var_types = var_types, contDigits = 1, save_table = FALSE,
  filename = "baseline.csv"
)
knitr::kable(tables$baseline) # Display the table
```

#### Example 3.2: RCS Plot
```{r example_3.2}
data(cancer, package = "survival")

# Performing cox regression, which is inferred by `y` and `time`
p <- rcs_plot(cancer, x = "age", y = "status", time = "time", covars = c("sex", "ph.karno"), save_plot = FALSE)
plot(p)
```

#### Example 3.3: Interaction Plot
```{r example_3.3}
data(cancer, package = "survival")

# Generating interaction plot of both linear and RCS models
p <- interaction_plot(cancer,
  y = "status", time = "time", predictor = "age",
  group_var = "sex", save_plot = FALSE
)
plot(p$lin)
plot(p$rcs)
```

#### Example 3.4: Regression Forest Plot
```{r example_3.4}
data(cancer, package = "survival")
cancer$dead <- cancer$status == 2 # Preparing a binary variable for logistic regression

# Performing multivairate logistic regression
p1 <- regression_forest(cancer,
  model_vars = c("age", "sex", "wt.loss"), y = "dead",
  as_univariate = FALSE, save_plot = FALSE
)
plot(p1)

p2 <- regression_forest(
  cancer,
  model_vars = list(
    Crude = c("age"),
    Model1 = c("age", "sex"),
    Model2 = c("age", "sex", "wt.loss")
  ),
  y = "dead",
  save_plot = FALSE
)
plot(p2)
```

#### Example 3.5: Subgroup Forest Plot
```{r example_3.5, out.width = "110%"}
data(cancer, package = "survival")
# coxph model with time assigned
p <- subgroup_forest(cancer,
  subgroup_vars = c("age", "sex", "wt.loss"), x = "ph.ecog", y = "status",
  time = "time", covars = "ph.karno", ticks_at = c(1, 2), save_plot = FALSE
)
plot(p)
```

## Documentation
For detailed usage, refer to the package vignettes (coming soon) or the [GitHub repository](https://github.com/yotasama/clinpubr).

## Contributing
Bug reports and feature requests are welcome via the [issue tracker](https://github.com/yotasama/clinpubr/issues).

## License
`clinpubr` is licensed under GPL (>= 3).